<?xml version="1.0" encoding="UTF-8"?>
<project name="DMDirc-Publish" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
    <description>Publish artifacts for DMDirc</description>

    <target name="-init-version">
        <taskdef name="git-describe" classname="org.mdonoughe.JGitDescribeTask" classpathref="lib.classpath"/>
    </target>

    <target name="-get-git-version" depends="-init-version">
        <git-describe dir="${git.dir}" property="parsers.version.main" subdir="${basedir}/${src.dir}/com/dmdirc/parser/common/;${basedir}/${src.dir}/com/dmdirc/parser/interfaces/" />
        <git-describe dir="${git.dir}" property="parsers.version.irc" subdir="${basedir}/${src.dir}/com/dmdirc/parser/irc/" />
    </target>

    <target name="publish-release" depends="-get-git-version, -init-ivy">
        <tstamp>
            <format property="timestamp" pattern="yyyyddMM" />
        </tstamp>
        <ivy:resolve file="ivy.common.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.common.xml" pubrevision="${parsers.version.main}" />
        <ivy:makepom ivyfile="${build.dir}/ivy.common.xml" pomfile="dist/parser.common.pom">
            <mapping conf="default" scope="compile"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="${parsers.version.main}"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.common.[ext]"
            resolver="upload-release"/>

        <ivy:resolve file="ivy.irc.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.irc.xml" pubrevision="${parsers.version.irc}" />
        <ivy:makepom ivyfile="${build.dir}/ivy.irc.xml" pomfile="dist/parser.irc.pom">
            <mapping conf="default" scope="compile"/>
            <dependency group="com.dmdirc.parser" artifact="common" version="${parsers.version.main}"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="${parsers.version.irc}"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.irc.[ext]"
            resolver="upload-release"/>
    </target>

    <target name="publish-nightlies" depends="-get-git-version, -init-ivy">
        <tstamp>
            <format property="timestamp" pattern="yyyyddMM" />
        </tstamp>
        <ivy:resolve file="ivy.common.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.common.xml" pubrevision="Nightly-${timestamp}_${parsers.version.main}" />
        <ivy:makepom ivyfile="${build.dir}/ivy.common.xml" pomfile="dist/parser.common.pom">
            <mapping conf="default" scope="compile"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="Nightly-${timestamp}_${parsers.version.main}"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.common.[ext]"
            resolver="upload-nightlies"/>

        <ivy:resolve file="ivy.irc.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.irc.xml" pubrevision="Nightly-${timestamp}_${parsers.version.irc}" />
        <ivy:makepom ivyfile="${build.dir}/ivy.irc.xml" pomfile="dist/parser.irc.pom">
            <mapping conf="default" scope="compile"/>
            <dependency group="com.dmdirc.parser" artifact="common" version="Nightly-${timestamp}_${parsers.version.main}"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="Nightly-${timestamp}_${parsers.version.irc}"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.irc.[ext]"
            resolver="upload-nightlies"/>
    </target>


    <target name="publish-snapshot" depends="-get-git-version, -init-ivy">
        <tstamp>
            <format property="timestamp" pattern="yyyyddMM" />
        </tstamp>
        <ivy:resolve file="ivy.common.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.common.xml" pubrevision="${parsers.version.main}-SNAPSHOT" />
        <ivy:makepom ivyfile="${build.dir}/ivy.common.xml" pomfile="dist/parser.common.pom">
            <mapping conf="default" scope="compile"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="${parsers.version.main}-SNAPSHOT"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.common.[ext]"
            resolver="upload-snapshot"/>

        <ivy:resolve file="ivy.irc.xml"/>
        <ivy:deliver deliverpattern="${build.dir}/ivy.irc.xml" pubrevision="${parsers.version.irc}-SNAPSHOT" />
        <ivy:makepom ivyfile="${build.dir}/ivy.irc.xml" pomfile="dist/parser.irc.pom">
            <mapping conf="default" scope="compile"/>
            <dependency group="com.dmdirc.parser" artifact="common" version="${parsers.version.main}-SNAPSHOT"/>
        </ivy:makepom>
        <ivy:retrieve/>
        <ivy:publish
            pubrevision="${parsers.version.irc}-SNAPSHOT"
            status="release"
            overwrite="true"
            publishivy="false"
            artifactspattern="dist/parser.irc.[ext]"
            resolver="upload-snapshot"/>
    </target>

    <target name="init-teamcity" depends="-init-ivy">
        <echo>Downloading private files, if this fails please pass username and</echo>
        <echo>password to ant using -Dusername=... -Dpassword=...</echo>

        <get src="http://www.dmdirc.com/private/nexus-teamcity.properties" dest="etc/nexus-teamcity.properties" username="${username}" password="${password}"/>
        <loadproperties srcFile="etc/nexus-teamcity.properties"/>

        <ivy:settings>
          <credentials host="nexus.dmdirc.com" realm="Sonatype Nexus Repository Manager" username="${nexus.user}" passwd="${nexus.pass}"/>
        </ivy:settings>
    </target>
</project>
